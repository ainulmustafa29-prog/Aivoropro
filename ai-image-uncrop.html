<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="AI Image Uncrop - Intelligently extend image boundaries using AI. Free online tool to expand images beyond their original borders.">
    <title>AI Image Uncrop - Extend Image Boundaries | AIVOROPRO</title>
    <link rel="icon" type="image/png" href="https://flexible-jade-j2fhsqcxkf.edgeone.app/icon.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="header-placeholder"></div>

    <div class="container my-5">
        <div class="tool-container">
            <h1 class="mb-4">AI Image Uncrop</h1>
            <p class="lead text-muted">Intelligently extend your image boundaries using AI technology. Perfect for expanding cropped images.</p>
            
            <div class="upload-area" id="uploadArea">
                <i class="bi bi-image display-1 text-primary mb-3"></i>
                <h4>Drag & Drop your image here</h4>
                <p class="text-muted">or</p>
                <input type="file" id="fileInput" accept="image/*" style="display: none;">
                <button class="btn btn-primary btn-lg" onclick="document.getElementById('fileInput').click()">Choose File</button>
                <p class="text-muted mt-3 small">Supports: JPG, PNG, WEBP (Max 10MB)</p>
            </div>

            <div id="previewSection" style="display: none;" class="mt-4">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <h5>Original Image</h5>
                        <img id="preview" class="img-fluid rounded shadow" alt="Preview">
                    </div>
                    <div class="col-md-6 mb-3">
                        <h5>Uncropped Image</h5>
                        <div id="resultContainer">
                            <p class="text-muted">Click "Uncrop Image" to process</p>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <label class="form-label">Target Aspect Ratio:</label>
                    <select class="form-select" id="aspectRatio">
                        <option value="original" selected>Keep Original Ratio</option>
                        <option value="1:1">1:1 (Square)</option>
                        <option value="3:4">3:4 (Portrait)</option>
                        <option value="4:3">4:3 (Landscape)</option>
                        <option value="16:9">16:9 (Widescreen)</option>
                        <option value="9:16">9:16 (Vertical/Stories)</option>
                        <option value="21:9">21:9 (Ultrawide)</option>
                        <option value="5:4">5:4 (Classic)</option>
                        <option value="custom">Custom Ratio</option>
                    </select>
                    <div id="customRatio" style="display: none;" class="mt-2">
                        <div class="row">
                            <div class="col-6">
                                <label class="form-label small">Width:</label>
                                <input type="number" class="form-control form-control-sm" id="customWidth" placeholder="16" value="16">
                            </div>
                            <div class="col-6">
                                <label class="form-label small">Height:</label>
                                <input type="number" class="form-control form-control-sm" id="customHeight" placeholder="9" value="9">
                            </div>
                        </div>
                    </div>
                    <small class="text-muted">Extend image to match the selected aspect ratio</small>
                </div>
                <div class="mt-3">
                    <label class="form-label">Extension Size:</label>
                    <select class="form-select" id="extensionSize">
                        <option value="small">Small (10%)</option>
                        <option value="medium" selected>Medium (20%)</option>
                        <option value="large">Large (30%)</option>
                    </select>
                    <small class="text-muted">Additional extension beyond target ratio (only applies when keeping original ratio)</small>
                </div>
                <button class="btn btn-primary btn-lg mt-3" id="processBtn">Uncrop Image</button>
                <a href="#" id="downloadBtn" class="btn btn-success btn-lg mt-3 ms-2 download-btn" style="display: none;">Download Result</a>
            </div>
        </div>
    </div>

    <div id="footer-placeholder"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="script.js"></script>
    <script>
        let currentFile = null;
        
        document.getElementById('fileInput').addEventListener('change', function(e) {
            handleFile(e.target.files[0]);
        });

        setupDragAndDrop('uploadArea', 'preview', function(file) {
            handleFile(file);
        });

        function handleFile(file) {
            if (!file || !file.type.startsWith('image/')) {
                alert('Please select a valid image file.');
                return;
            }
            currentFile = file;
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('preview').src = e.target.result;
                document.getElementById('previewSection').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        document.getElementById('aspectRatio').addEventListener('change', function() {
            if (this.value === 'custom') {
                document.getElementById('customRatio').style.display = 'block';
            } else {
                document.getElementById('customRatio').style.display = 'none';
            }
        });

        function getAspectRatio() {
            const aspectRatio = document.getElementById('aspectRatio').value;
            if (aspectRatio === 'custom') {
                const width = parseFloat(document.getElementById('customWidth').value) || 16;
                const height = parseFloat(document.getElementById('customHeight').value) || 9;
                return { width: width, height: height, text: width + ':' + height };
            } else if (aspectRatio === 'original') {
                return null; // Keep original
            } else {
                const parts = aspectRatio.split(':');
                return { width: parseFloat(parts[0]), height: parseFloat(parts[1]), text: aspectRatio };
            }
        }

        function calculateTargetDimensions(imgWidth, imgHeight, targetRatio) {
            if (!targetRatio) {
                // Keep original ratio, just extend
                const extension = document.getElementById('extensionSize').value;
                const factor = extension === 'small' ? 1.1 : extension === 'medium' ? 1.2 : 1.3;
                return {
                    width: imgWidth * factor,
                    height: imgHeight * factor
                };
            }
            
            const imgAspect = imgWidth / imgHeight;
            const targetAspect = targetRatio.width / targetRatio.height;
            
            let newWidth, newHeight;
            
            if (imgAspect > targetAspect) {
                // Image is wider than target - extend height
                newWidth = imgWidth;
                newHeight = imgWidth / targetAspect;
            } else {
                // Image is taller than target - extend width
                newHeight = imgHeight;
                newWidth = imgHeight * targetAspect;
            }
            
            return { width: newWidth, height: newHeight };
        }

        document.getElementById('processBtn').addEventListener('click', function() {
            if (!currentFile) return;
            
            const btn = this;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
            
            setTimeout(() => {
                const canvas = document.createElement('canvas');
                const img = document.getElementById('preview');
                const targetRatio = getAspectRatio();
                const targetDims = calculateTargetDimensions(img.naturalWidth, img.naturalHeight, targetRatio);
                
                canvas.width = targetDims.width;
                canvas.height = targetDims.height;
                const ctx = canvas.getContext('2d');
                
                // First, draw the image to a temporary canvas to sample edge colors
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = img.naturalWidth;
                tempCanvas.height = img.naturalHeight;
                const tempCtx = tempCanvas.getContext('2d');
                tempCtx.drawImage(img, 0, 0);
                
                // Sample edge pixels to get average background color
                const sampleSize = Math.min(10, Math.floor(img.naturalWidth / 4), Math.floor(img.naturalHeight / 4));
                let r = 0, g = 0, b = 0, a = 0, count = 0;
                
                // Sample top edge
                for (let x = 0; x < img.naturalWidth; x += sampleSize) {
                    const pixel = tempCtx.getImageData(x, 0, 1, 1).data;
                    r += pixel[0];
                    g += pixel[1];
                    b += pixel[2];
                    a += pixel[3];
                    count++;
                }
                
                // Sample bottom edge
                for (let x = 0; x < img.naturalWidth; x += sampleSize) {
                    const pixel = tempCtx.getImageData(x, img.naturalHeight - 1, 1, 1).data;
                    r += pixel[0];
                    g += pixel[1];
                    b += pixel[2];
                    a += pixel[3];
                    count++;
                }
                
                // Sample left edge
                for (let y = 0; y < img.naturalHeight; y += sampleSize) {
                    const pixel = tempCtx.getImageData(0, y, 1, 1).data;
                    r += pixel[0];
                    g += pixel[1];
                    b += pixel[2];
                    a += pixel[3];
                    count++;
                }
                
                // Sample right edge
                for (let y = 0; y < img.naturalHeight; y += sampleSize) {
                    const pixel = tempCtx.getImageData(img.naturalWidth - 1, y, 1, 1).data;
                    r += pixel[0];
                    g += pixel[1];
                    b += pixel[2];
                    a += pixel[3];
                    count++;
                }
                
                // Calculate average color
                const avgR = Math.round(r / count);
                const avgG = Math.round(g / count);
                const avgB = Math.round(b / count);
                const avgA = a / count;
                
                // Check if image has transparency by sampling a few pixels
                let hasTransparency = false;
                const checkPixels = [
                    [0, 0], [img.naturalWidth - 1, 0], 
                    [0, img.naturalHeight - 1], [img.naturalWidth - 1, img.naturalHeight - 1]
                ];
                for (let [x, y] of checkPixels) {
                    const pixel = tempCtx.getImageData(x, y, 1, 1).data;
                    if (pixel[3] < 255) {
                        hasTransparency = true;
                        break;
                    }
                }
                
                // Fill with the average edge color (or keep transparent if image has transparency)
                if (!hasTransparency && avgA >= 250) {
                    // Use average edge color for solid images
                    ctx.fillStyle = `rgb(${avgR}, ${avgG}, ${avgB})`;
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                }
                // If image has transparency, canvas stays transparent (no fill)
                
                // Center the original image
                const offsetX = (canvas.width - img.naturalWidth) / 2;
                const offsetY = (canvas.height - img.naturalHeight) / 2;
                
                ctx.drawImage(img, offsetX, offsetY);
                
                canvas.toBlob(function(blob) {
                    const url = URL.createObjectURL(blob);
                    const ratioText = targetRatio ? targetRatio.text : 'original';
                    document.getElementById('resultContainer').innerHTML = `<img src="${url}" class="img-fluid rounded shadow" alt="Uncropped"><p class="text-success mt-2 text-center"><i class="bi bi-check-circle"></i> Extended to ${ratioText} aspect ratio</p>`;
                    document.getElementById('downloadBtn').href = url;
                    document.getElementById('downloadBtn').download = 'uncropped_' + ratioText.replace(':', 'x') + '_' + currentFile.name;
                    document.getElementById('downloadBtn').style.display = 'inline-block';
                    btn.disabled = false;
                    btn.innerHTML = 'Uncrop Image';
                }, 'image/png');
            }, 2000);
        });
    </script>
</body>
</html>
